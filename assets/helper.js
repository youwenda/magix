/*author:xinglie.lkf@taobao.com*/
!function(){var e=document;if(!e._magix){e._magix=1;var t={created:"#008B00",init:"#FF3030",alter:"#BC8F8F",isolated:"#FF3030",build:"#9AC0CD"},a={width:550,height:470,canvasWidth:530,canvasHeight:400,moreInfoWidth:490,titleHeight:34,circleMargin:6,minCircleRadius:15,managerCols:5,managerMargin:5,managerHeight:40,managerGroupSpace:40,eventsStartColor:{r:0,g:153,b:102},eventsEndColor:{r:255,g:255,b:0},eventsCommonCount:15},i=["FFC125","C71585","0000AA","CDBA96","FF7F00","BA55D3","8B4726","7CFC00","4A4A4A","EE7AE9"],r={cache:"#CC9966",cleaned:"#99CCCC",cleans:"#FF9999",normal:"#CCCC99"},n=function(e,t){var a=document.createElement("style");document.documentElement.appendChild(a),a.styleSheet?a.styleSheet.cssText=t:a.appendChild(document.createTextNode(t))};n("i-bca",".i-bca-icon:before{width:12px;content:'M';height:12px;border-radius:6px;position:absolute;background-color:#008b00;opacity:.4;font-size:10px;line-height:12px;text-align:center;color:#fff;z-index:2147483645}.i-bca-tle{padding-right:5px}.i-bca-tab{background:#eee;cursor:move}.i-bca-main{position:fixed;right:20px;top:20px;width:550px;height:470px;z-index:2147483647;box-shadow:0 0 10px #b9b9b9;background-color:#fff;font-size:12px;line-height:1.5}.i-bca-mask{position:absolute;opacity:.7;background-color:#90ee90}.i-bca-main ul{list-style:none;padding:0}.i-bca-m5{margin-left:5px}.i-bca-binfo{padding:5px}.i-bca-fl{float:left}.i-bca-fr{float:right}.i-bca-cp{cursor:pointer}.i-bca-p8{padding:8px}.i-bca-move{cursor:move}.i-bca-red{color:red}.i-bca-clearfix:after,.i-bca-clearfix:before{content:\"\";display:table}.i-bca-clearfix:after{clear:both}.i-bca-clearfix{*zoom:1}.i-bca-bar{height:1px;border:0;padding:0;margin:5px;background:rgba(0,0,0,.2);background:-webkit-gradient(linear,left top,right top,from(rgba(165,69,243,0)),color-stop(.5,hsla(270,6%,49%,.33)),to(rgba(165,69,243,0)))}#mx_manager_moreinfo,#mx_moreinfo{position:absolute;background-color:#eee;padding:8px;width:440px;display:none;box-shadow:0 5px 10px #b9b9b9}");var o={main:'<div class="i-bca-main" id="mx"><ul class="i-bca-clearfix i-bca-tab" id="mx_tabs"><li class="i-bca-fl i-bca-p8 i-bca-cp">VOM</li><li class="i-bca-fl i-bca-p8 i-bca-cp">Tracer</li><li class="i-bca-fl i-bca-p8 i-bca-cp">Manager</li><li class="i-bca-fr i-bca-p8 i-bca-cp" id="mx_min">△</li></ul><div id="mx_painter"><div style="width:{width}px;height:{canvasHeight}px;overflow-x:auto;overflow-y:hidden" id="mx_view_cnt"><canvas width="{width}" height="{canvasHeight}" id="mx_view_canvas"></canvas></div><ul class="i-bca-clearfix i-bca-p8" id="mx_view_total"></ul></div><div id="mx_trancer" style="height:{canvasHeight}px;overflow:scroll;overflow-x:auto;display:none;padding:8px"></div><div id="mx_manager" style="display:none"><div style="height:{canvasHeight}px;overflow:scroll;overflow-x:auto" id="mx_manager_cnt"><canvas width="{canvasWidth}" height="{canvasHeight}" id="mx_manager_canvas"></canvas></div><ul class="i-bca-clearfix i-bca-p8" id="mx_manager_total"></ul></div><div id="mx_moreinfo"></div><div id="mx_manager_moreinfo"></div></div>',moreInfo:'<ul><li><b class="i-bca-tle">id:</b>{id}</li><li><b class="i-bca-tle">view:</b>{view}</li>{events} {share}<li class="i-bca-red">{ex}</li><li><b class="i-bca-tle">resources:</b></li><li style="{moreInfoWidth}px;overflow:auto;max-height:200px">{res}</li></ul>',moreManagerInfo:"<ul><li><b>key:</b>{id}</li><li><b>url:</b>{url}</li><li><b>描述:</b>{desc}</li><li><b>缓存:</b>{cache}</li><li><b>清理缓存:</b>{cleans}</li><li><b>预处理:</b>{hasAfter}</li></ul>",total:'<li class="i-bca-fl i-bca-binfo">共{total}个view</li><li class="i-bca-fl ml5 i-bca-red i-bca-binfo">{ex}</li>',managerTotal:'<li class="i-bca-fl i-bca-binfo">{groups}个接口文件，共{total}个接口</li>',setup:function(){var t=e.createElement("div");t.innerHTML=o.main.replace(/\{(\w+)\}/g,function(e,t){return a[t]}),e.documentElement.appendChild(t),o.attachEvent();var i=f.getEnv();i.dragIt("#mx","#mx_tabs")},attachEvent:function(){o.detachEvent();var t,i=f.getEnv();i.bind("mx_view_canvas","mousemove",o.$mousemove=function(e){clearTimeout(t),t=setTimeout(function(){var t=i.getDOMOffset("mx_view_canvas");o.onMousemove({x:e.pageX-t.left,y:e.pageY-t.top})},10)}),i.bind("mx_view_canvas","mouseout",o.$mouseout=function(){clearTimeout(t),o.onMousemove({x:-1,y:-1})}),i.bind("mx_manager_canvas","mousemove",o.$mangerMousemove=function(e){clearTimeout(t),t=setTimeout(function(){var t=i.getDOMOffset("mx_manager_canvas");o.onManagerMousemove({x:e.pageX-t.left,y:e.pageY-t.top})},10)}),i.bind("mx_manager_canvas","mouseout",o.$managerMouseout=function(){clearTimeout(t),o.onManagerMousemove({x:-1,y:-1})}),i.bind("mx_moreinfo","mouseover",o.$imouseover=function(){clearTimeout(o.$hideTimer)}),i.bind("mx_moreinfo","mouseout",o.$imouseout=function(){o.hideMoreInfo()}),i.bind("mx","click",o.$click=function(t){var i;"mx_min"==t.target.id?(i=e.getElementById("mx"),"△"==t.target.innerHTML?(i.style.height=a.titleHeight+"px",i.style.overflow="hidden",t.target.innerHTML="▽"):(i.style.height=a.height+"px",i.style.overflow="inherit",t.target.innerHTML="△")):"VOM"==t.target.innerHTML?(i=e.getElementById("mx_painter"),i.style.display="block",i=e.getElementById("mx_trancer"),i.style.display="none",i=e.getElementById("mx_manager"),i.style.display="none"):"Tracer"==t.target.innerHTML?(i=e.getElementById("mx_painter"),i.style.display="none",i=e.getElementById("mx_manager"),i.style.display="none",i=e.getElementById("mx_trancer"),i.style.display="block"):"Manager"==t.target.innerHTML&&(i=e.getElementById("mx_painter"),i.style.display="none",i=e.getElementById("mx_trancer"),i.style.display="none",i=e.getElementById("mx_manager"),i.style.display="block")})},detachEvent:function(){var e=f.getEnv();e.unbind("mx_view_canvas","mousemove",o.$mousemove),e.unbind("mx_view_canvas","mouseout",o.$mouseout),e.unbind("mx_manager_canvas","mousemove",o.$managerMousemove),e.unbind("mx_manager_canvas","mouseout",o.$managerMouseout),e.unbind("mx_min","click",o.$click),e.unbind("mx_moreinfo","mouseoout",o.$imouseout),e.unbind("mx_moreinfo","mouseover",o.$imouseover)},showMoreInfo:function(t,i){clearTimeout(o.$hideTimer);var r=e.getElementById("mx_cover");r||(r=e.createElement("div"),r.className="i-bca-mask",r.id="mx_cover",e.body.appendChild(r));var n=e.getElementById("mx_moreinfo");n.style.display="block";var s=i.center.x-a.moreInfoWidth/2-e.getElementById("mx_view_cnt").scrollLeft;n.style.left=s+"px",n.style.top=i.center.y+i.radius+a.titleHeight+5+"px";var l=f.getEnv();l.updateDOMStyle(r.style,t.id),r.style.display="block",n.innerHTML=o.moreInfo.replace(/\{(\w+)\}/g,function(e,r){switch(r){case"id":return i.id;case"view":return t?t.path||t.view&&t.view.path||"":"";case"events":var n=f.getEvents(t);return n.length?'<li><b class="tle">events:</b>'+n+"</li>":"";case"share":var o=f.getShared(t);return o.length?'<li><b class="tle">share:</b>'+o+"</li>":"";case"ex":if(i.il)return"被孤立的节点，好可怜……";if(!t)return"vframe已被销毁，但未从vom中移除";if(t.path){if(t.cM&&!t.view||t.$c&&!t.$v)return"未加载view"}else if(!t.view)return"未加载view";if(t.cM){if(!t.fcc)return t.rC!=t.cC?"正等待子view加载":"正等待view加载"}else if(!t.$cr)return t.$rc!=t.$cc?"正等待子view加载":"正等待view加载";return t.fca||t.$ca?"等待view渲染":"";case"res":var s=[],c=t&&t.view&&t.view.$res;if(c=c||t&&t.$v&&t.$v.$r){var d;for(var g in c){d=!0;break}if(d){s.push('<table style="width:100%"><tr><td>key</td><td>type</td></tr>');for(var g in c)s.push("<tr><td>",g,"</td><td>",l.getResType(c[g]),"</td></tr>");s.push("</table>")}}return s.join("");default:return a[r]}})},hideMoreInfo:function(){var t=e.getElementById("mx_moreinfo"),a=e.getElementById("mx_cover");o.$hideTimer=setTimeout(function(){t.style.display="none",a.style.display="none"},150)},showManagerMoreInfo:function(t){clearTimeout(o.$hideManagerTimer);var i=e.getElementById("mx_manager_moreinfo");i.style.display="block",i.style.left=t.rect[0]+"px";var r=t.rect[1]+t.rect[3]+a.titleHeight,n=e.getElementById("mx_manager_cnt").scrollTop;r-=n,i.style.top=r+"px",i.innerHTML=o.moreManagerInfo.replace(/\{(\w+)\}/g,function(e,a){switch(a){case"id":return t.id;default:return t[a]}})},hideManagerMoreInfo:function(){var t=e.getElementById("mx_manager_moreinfo");o.$hideManagerTimer=setTimeout(function(){t.style.display="none"},150)},showManagerTotal:function(t){var a=e.getElementById("mx_manager_total");a.innerHTML=o.managerTotal.replace(/\{(\w+)\}/g,function(e,a){switch(a){case"groups":return t.groups.length;case"total":return t.total}})},showTotal:function(t,a){var i=e.getElementById("mx_view_total");i.innerHTML=o.total.replace(/\{(\w+)\}/g,function(e,a){switch(a){case"total":return t.vomTotal;case"ex":return t.total!=t.vomTotal?'<b style="color:red">vom中共'+t.vomTotal+"个view，而只有"+t.total+"个存在关联</b>":""}})},updateManagerCanvasHeight:function(t){e.getElementById("mx_manager_canvas").height=0|t},updateVOMCanvansWidth:function(t){var i=e.getElementById("mx_view_canvas");i.width=0|t,i.parentNode.scrollLeft=(i.width-a.canvasWidth)/2},onMousemove:function(e){},onManagerMousemove:function(e){}},s={log:function(t,a){var i=e.getElementById("mx_trancer");if(s.idle){var r=e.createElement("hr");r.className="i-bca-bar",i.insertBefore(r,i.firstChild),delete s.idle}var n=e.createElement("div");n.innerHTML=t,a&&(n.style.color=a),i.insertBefore(n,i.firstChild),i.getElementsByTagName("div").length>200&&(i.removeChild(i.lastChild),i.removeChild(i.lastChild)),clearTimeout(s.$timer),s.$timer=setTimeout(function(){s.idle=!0},1500)}},l={captureItmes:function(){var e=l;e.list=[],delete e.$last,o.onMousemove=function(t){var a,i,r;if(e.$last?(i=e.$last,r=Math.pow(Math.pow(i.center.x-t.x,2)+Math.pow(i.center.y-t.y,2),.5),r>i.radius&&(e.onHoverItem({item:i,action:"leave"}),delete e.$last,a=!0)):a=!0,a)for(var n=e.list.length-1;n>=0;n--)if(i=e.list[n],r=Math.pow(Math.pow(i.center.x-t.x,2)+Math.pow(i.center.y-t.y,2),.5),r<=i.radius){e.$last!=i&&(e.$last=i,e.onHoverItem({item:i,action:"enter"}));break}}},captureManagerItmes:function(){var e=l;e.managerList=[],delete e.$managerLast,o.onManagerMousemove=function(t){var a,i,r;if(e.$managerLast?(i=e.$managerLast,r=i.rect,(t.x<r[0]||t.y<r[1]||t.x>r[0]+r[2]||t.y>r[1]+r[3])&&(e.onHoverManagerItem({item:i,action:"leave"}),delete e.$managerLast,a=!0)):a=!0,a)for(var n=e.managerList.length-1;n>=0;n--)i=e.managerList[n],r=i.rect,t.x>=r[0]&&t.y>=r[1]&&t.x<=r[0]+r[2]&&t.y<=r[1]+r[3]&&e.$managerLast!=i&&(e.$managerLast=i,e.onHoverManagerItem({item:i,action:"enter"}))}},getBestParams:function(e,t,i){var r=0,n=0,s={},l=0,c=function(e,t){e.deep=t,e.children.length>l&&(l=e.children.length),e.deep>n&&(n=e.deep),s[t]?s[t]+=e.children.length:s[t]=e.children.length,s[t]>r&&(r=s[t]);for(var a=e.children.length-1;a>=0;a--)c(e.children[a],e.deep+1)};c(e,1),r=Math.max(r,e.isolated.length+1);var d=t/r-a.circleMargin,g=i/n-a.circleMargin,m=t,u=2*a.minCircleRadius;d<u?(d=u,m=u*r+(r+1)*a.circleMargin,m>3e4&&(m=3e4),o.updateVOMCanvansWidth(m)):o.updateVOMCanvansWidth(m);var h=Math.floor(Math.min(g,d)/2),v=(h/20).toFixed(1);return{width:m,max:r,maxOne:l,deep:n,margin:a.circleMargin,radius:h,band:v}},getChildrenCountByDeep:function(e,t){var a=0,i=function(e){e.deep==t&&e.children.length&&(e.leftIndex=a,a+=e.children.length);for(var r=0;r<e.children.length;r++)i(e.children[r])};return i(e),a},drawTree:function(t){if(t.id){var r=a.width,n=a.canvasHeight,s=l;s.captureItmes();var c=s.getBestParams(t,r,n);r=c.width;var d=e.getElementById("mx_view_canvas").getContext("2d");d.clearRect(0,0,r,n);var g=2*c.radius-2*(c.band+1)-1;s.$tWidth||(s.$tWidth={});var m=function(e){return s.$tWidth[e]||(d.font="normal 12px Arial",s.$tWidth[e]=d.measureText(e).width),s.$tWidth[e]},u=function(e){for(var t=1,a=0;t<=e.length;){if(a+=m(e.substring(t-1,t)),!(a<g))return e.substring(0,t-3)+"..";t+=1}return e},h=0,v=function(e,a,n,o){if(n){d.beginPath();var s=180*Math.atan((a.y-n.y)/(a.x-n.x))/Math.PI;s<0&&(s+=180);var g=Math.round(n.x+c.radius*Math.cos(s*Math.PI/180)),m=Math.round(n.y+c.radius*Math.sin(s*Math.PI/180));d.moveTo(g,m),d.lineTo(a.x,a.y),d.lineWidth=1,d.strokeStyle=o,d.stroke()}var u=l.getChildrenCountByDeep(t,e.deep);if(u)for(var f=(r-(u*c.radius*2+(u-1)*c.margin))/2,p="#"+i[h++%i.length],x=0;x<e.children.length;x++)v(e.children[x],{x:f+(x+e.leftIndex)*(2*c.radius+c.margin)+c.radius,y:a.y+c.margin+2*c.radius},a,p)},f=function(e,a){a.x<0,d.moveTo(a.x,a.y),d.beginPath(),d.arc(a.x,a.y,c.radius,0,2*Math.PI,!0),d.fillStyle=e.status,d.fill();var i=Math.max(.5,c.radius/10),n=a.y+c.radius/2;if(e.event){var o=a.x-c.radius/2+i;d.moveTo(o,n),d.beginPath(),d.arc(o,n,i,0,2*Math.PI,!0),d.fillStyle=e.event,d.fill()}if(e.shared){var g=a.x+c.radius/2-i;d.moveTo(g,n),d.beginPath(),d.arc(g,n,i,0,2*Math.PI,!0),d.fillStyle=e.shared,d.fill()}d.moveTo(a.x,a.y),d.beginPath(),d.arc(a.x,a.y,c.radius-c.band-1,0,2*Math.PI,!0),d.lineWidth=c.band,d.strokeStyle="#fff",d.stroke(),s.list.push({id:e.id,center:a,il:e.il,radius:c.radius}),d.beginPath(),d.moveTo(a.x,a.y),d.font="normal 12px Arial",d.fillStyle="#eee";var m=u(e.id),h=Math.round(d.measureText(m).width),v=(2*c.radius-h)/2;d.fillText(m,a.x+v-c.radius,a.y+4);var p=l.getChildrenCountByDeep(t,e.deep);if(p)for(var x=(r-(p*c.radius*2+(p-1)*c.margin))/2,b=0;b<e.children.length;b++)f(e.children[b],{x:x+(b+e.leftIndex)*(2*c.radius+c.margin)+c.radius,y:a.y+c.margin+2*c.radius})},p=t.isolated,x=r/2;if(p.length){x=(r-(p.length+1)*c.radius*2+p.length*c.margin)/2;for(var b=0;b<p.length;b++)f(p[b],{x:x+(b+1)*(2*c.radius+c.margin)+c.radius,y:c.margin+c.radius});x+=c.radius}v(t,{x:x,y:c.margin+c.radius}),f(t,{x:x,y:c.margin+c.radius}),o.showTotal(t,c)}},drawManagerTree:function(t){var r=l;r.captureManagerItmes();var n=a.managerMargin*(t.rows+1)+t.rows*a.managerHeight+(a.managerGroupSpace+a.managerMargin)*t.groups.length;o.updateManagerCanvasHeight(n);var s=e.getElementById("mx_manager_canvas").getContext("2d");s.clearRect(0,0,a.canvasWidth,n);var c=a.managerMargin,d=(a.canvasWidth-(1+a.managerCols)*a.managerMargin)/a.managerCols|0,g=function(){s.font="normal 14px Arial";var e=s.measureText("M").width;return e}(),m=function(e,t,a,i){e.beginPath(),e.moveTo(t[0],t[1]),e.fillStyle=a.color,e.fillRect(t[0],t[1],t[2],t[3]),e.beginPath(),e.moveTo(t[0],t[1]+10),e.font="normal 14px Arial",e.fillStyle="#282828";for(var n,o=a.id;(o.length-3)*g>t[2];)o=o.slice(0,-1),n=!0;n&&(o=o.slice(0,-3)+"..."),e.fillText(o,t[0]+5,t[1]+25),a["package"]=i,a.rect=t,r.managerList.push(a)},u=function(e){for(var t=0;t<e.length;t++){var r=e[t],n=a.managerMargin,o=!1;s.beginPath(),s.moveTo(n,c),s.font="normal 14px Arial",s.fillStyle="#282828",s.fillText(r.name,n+5,c+25),c+=a.managerGroupSpace;var l,g,u=Math.max(r.maxLeft,r.maxRight),h={},v=0,f=(u-r.maxLeft)/2*(a.managerHeight+a.managerMargin),p=(u-r.maxRight)/2*(a.managerHeight+a.managerMargin);for(l=0;l<u;l++){var x=r.cleans.left[l],b=r.cleans.right[l];x&&(m(s,[n,c+f,150,a.managerHeight],x,r.name),h[x.id]=x),b&&(m(s,[a.canvasWidth-a.managerMargin-150,c+p,150,a.managerHeight],b,r.name),h[b.id]=b,b.lineColor=i[v++%i.length]),c+=a.managerMargin+a.managerHeight}for(var M in h)if(g=h[M],g.cleans)for(var w={x:g.rect[0]+g.rect[2],y:g.rect[1]+(g.rect[3]/2|0)},y=(g.cleans+"").split(","),_=y.length-1;_>=0;_--){var I=h[y[_]],T={x:I.rect[0],y:I.rect[1]+(I.rect[3]/2|0)};s.beginPath(),s.moveTo(w.x,w.y),s.lineTo(T.x,T.y),s.lineWidth=1,s.strokeStyle="#"+(I.lineColor||"996699"),s.stroke()}for(l=0;l<r.caches.length;l++)m(s,[n,c,d,a.managerHeight],r.caches[l],r.name),(l+1)%a.managerCols===0?(n=a.managerMargin,c+=a.managerMargin+a.managerHeight,o=!1):(n+=d+a.managerMargin,o=!0);for(n=a.managerMargin,o&&(c+=a.managerMargin+a.managerHeight),l=0;l<r.items.length;l++)g=r.items[l],m(s,[n,c,d,a.managerHeight],g,r.name),(l+1)%a.managerCols===0?(n=a.managerMargin,c+=a.managerMargin+a.managerHeight,o=!1):(n+=d+a.managerMargin,o=!0);n=a.managerMargin,o&&(c+=a.managerGroupSpace)}};u(t.groups),o.showManagerTotal(t)},onHoverItem:function(e){var t=f.getEnv(),a=t.getVOM();"enter"==e.action?o.showMoreInfo(a.get(e.item.id),e.item):o.hideMoreInfo()},onHoverManagerItem:function(e){"enter"==e.action?o.showManagerMoreInfo(e.item):o.hideManagerMoreInfo()}},c=window.KISSY,d={prepare:function(){c.use("node")},getRootId:function(){var e,t=c.Env.mods["magix/magix"];return e=t?c.require("magix/magix"):c.require("magix"),e.config("rootId")},getVOM:function(){var e=c.Env.mods["magix/magix"];if(e)return c.require("magix/vom");var t=c.require("magix");return t.VOM||t.Vframe},getMangerMods:function(){var e=c.Env.mods,t=[];for(var a in e){var i=e[a].exports||e[a].value;i&&(i.$mMetas&&i.$mCache||i.$mm&&i.$mc||i.$m&&i.$c)&&t.push({name:e[a].name,exports:i})}return t},isReady:function(){var e=c.Env.mods["magix/magix"],t=c.Env.mods.node;if(e){var a=c.Env.mods["magix/vom"];return e.status===c.Loader.Status.ATTACHED&&a&&a.status===c.Loader.Status.ATTACHED&&t&&t.status===c.Loader.Status.ATTACHED}return e=c.Env.mods.magix,e&&e.status===c.Loader.Status.ATTACHED&&t&&t.status===c.Loader.Status.ATTACHED},updateDOMStyle:function(e,t){var a=c.require("node").one("#"+t);if(a){var i=a,r={height:i.outerHeight?i.outerHeight():i.height(),width:i.outerWidth?i.outerWidth():i.width()};if(r.height){var n=a.offset();e.left=n.left+"px",e.top=n.top+"px",e.position="absolute",r.width=Math.max(r.width,a.children().width());var o=-1;do{var s=parseInt(a.css("z-index"))||1;s&&s>o&&(o=s),a=a.parent()}while(a);e.zIndex=o+1}else{var l=4,d=i;do{if(l--,!l)break;if(d=d.children(),r.height=d.height(),r.height){r.width=d.width();var g=d.css("position");if("fixed"==g){i=d.css("left"),e.left=i,e.position=g,i=d.css("top"),e.top=i,i=d.css("right"),e.right=i,i=d.css("bottom"),e.bottom=i;var o=parseInt(d.css("z-index"))||1;e.zIndex=o+1}else{var n=d.offset();e.left=n.left+"px",e.top=n.top+"px",e.position="absolute",r.width=Math.max(r.width,d.children().width());var o=-1;do{var s=parseInt(d.css("z-index"))||1;s&&s>o&&(o=s),d=d.parent()}while(d);e.zIndex=o+1}break}}while(!r.height)}e.width=r.width+"px",e.height=r.height+"px"}},getDOMOffset:function(e){var t=c.require("node");return t.one("#"+e).offset()},bind:function(e,t,a){var i=c.require("node");return c.isString(e)&&(e="#"+e),i.one(e).on(t,a)},unbind:function(e,t,a){var i=c.require("node");return c.isString(e)&&(e="#"+e),i.one(e).detach(t,a)},getResType:function(e){var t="",a=e.res||e.e;if(a)if(a.all&&a.constructor&&a.constructor.cached)t="Magix.Service";else if(a.fetchAll||a.all&&a.one&&a.next&&a.then)t="Model Manager";else if(a.bricks)t="Pagelet";else if(a.__attrs&&a.__attrVals&&a.constructor){var i,r=c.Env.mods;for(var n in r){var o=r[n],s=o.value||o.exports;if(s&&a.constructor==s){t=o.name,i=!0;break}}i||(t=a.hasOwnProperty("pagelet")?"Brick":"extend S Attribute")}else t=c.isFunction(a)?"函数或构造器":c.type(a);else t=c.type(a);return t},hookAttachMod:function(e){var t=c.Loader.Utils.attachMod;c.Loader.Utils.attachMod=function(){t.apply(c.Loader.Utils,arguments),e()}},dragIt:function(e,t){c.use("dd",function(a,i){new i.Draggable({node:e,move:!0,handlers:[t]})})},drawIcons:function(){var e=this.getVOM().all();for(var t in e){var a=c.one("#"+t);a.addClass("i-bca-icon")}}},g={prepare:function(){},hookAttachMod:function(){},getMod:function(e){return require.s.contexts._.defined[e]},getDL:function(){return this.getMod("$")||this.getMod("jquery")||this.getMod("zepto")},getRootId:function(){var e,t=this.getMod("magix/magix");return e=t?t:this.getMod("magix"),e.config("rootId")},getVOM:function(){var e=this.getMod("magix/vom");if(e)return e;var t=this.getMod("magix");return t.VOM||t.Vframe},getMangerMods:function(){var e=require.s.contexts._.defined,t=[];for(var a in e){var i=e[a];i&&(i.$mMetas&&i.$mCache||i.$mm&&i.$mc||i.$m&&i.$c)&&t.push({name:a,exports:i})}return t},isReady:function(){return this.getMod("magix/magix")||this.getMod("magix")},updateDOMStyle:function(e,t){var a=this.getDL(),i=a("#"+t),r=i,n={height:r.outerHeight?r.outerHeight():r.height(),width:r.outerWidth?r.outerWidth():r.width()};if(n.height){var o=i.offset();e.left=o.left+"px",e.top=o.top+"px",e.position="absolute",n.width=Math.max(n.width,i.children().width());var s=-1;do{var l=parseInt(i.css("z-index"))||1;l&&l>s&&(s=l),i=i.parent()}while(i.length&&a.contains(document.body,i[0]));e.zIndex=s+1}else{var c=4,d=r;do{if(c--,!c)break;if(d=d.children(),n.height=d.height(),n.height){var g=d.css("position");if("fixed"==g){r=d.css("left"),e.left=r,e.position=g,r=d.css("top"),e.top=r,r=d.css("right"),e.right=r,r=d.css("bottom"),e.bottom=r;var s=parseInt(d.css("z-index"))||1;e.zIndex=s+1}else{var o=d.offset();e.left=o.left+"px",e.top=o.top+"px",e.position="absolute",n.width=Math.max(n.width,d.children().width());var s=-1;do{var l=parseInt(d.css("z-index"))||1;l&&l>s&&(s=l),d=d.parent()}while(d.length&&a.contains(document.body,d[0]));e.zIndex=s+1}break}}while(!n.height)}e.width=n.width+"px",e.height=n.height+"px"},getDOMOffset:function(e){var t=this.getDL();return t("#"+e).offset()},bind:function(e,t,a){var i=this.getDL();return"string"==i.type(e)&&(e="#"+e),i(e).on(t,a)},unbind:function(e,t,a){var i=this.getDL();return"string"==i.type(e)&&(e="#"+e),i(e).off(t,a)},getResType:function(e){var t=e.res||e.e,a=this.getDL(),i=a.type(e);return t&&(t.all&&t.constructor&&t.constructor.cached?i="Magix.Service":t.fetchAll||t.all&&t.one&&t.next&&t.then?i="Model Manager":t.bricks?i="Pagelet":a.isFunction(t)&&(i="函数或构造器")),i},dragIt:function(e,t){var a=this.getDL(),i=a(e);a(t).on("mousedown",function(e){var t=parseInt(i.css("right"),10),r=parseInt(i.css("top"),10),n=e.pageX,o=e.pageY,s=function(e){var a=e.pageX-n,s=e.pageY-o;i.css({right:t-a,top:r+s})},l=function(){c.off("mousemove",s).off("mouseup",l)},c=a(document);c.on("mousemove",s).on("mouseup",l)})},drawIcons:function(){var e=this.getVOM().all(),t=this.getDL();for(var a in e){var i=t("#"+a);i.addClass("i-bca-icon")}}},m={},u={},h={};for(var v in g)m[v]=u[v]=h[v]=g[v];m.getMod=function(e){try{var t=seajs.require(e);return t}catch(a){}var i=seajs.cache;for(var r in i){var n=i[r];if(n.id===e)return n.exports}},m.getMangerMods=function(){var e=seajs.cache,t=[];for(var a in e){var i=e[a],r=i.exports;r&&r.$m&&r.$s&&t.push({name:i.id,exports:r})}return t},u.getMod=function(e){try{return require(e)}catch(t){return null}},u.getMangerMods=function(){return[]},h.getDL=function(){return window.$||window.jQuery},h.getRootId=function(){return Magix.config("rootId")},h.getVOM=function(){return Magix.VOM||Magix.Vframe},h.getMangerMods=function(){return[]},h.isReady=function(){return!0};var f={getEnv:function(){if(window.KISSY)return d;if(window.requirejs)return g;if(window.seajs)return m;if(window.define&&window.require)return u;if(window.Magix)return h;throw new Error("unsupport")},getEvents:function(e){var t=[];if(e){var a=e.view&&(e.view.events||e.view.$evts)||e.$v&&e.$v.$eo;for(var i in a)t.push(i)}return t},getShared:function(e){var t=[];if(e&&e.$v){var a=e.$v.$sd;if(a)for(var i in a)t.push(i)}return t},getTree:function(e){var i=e.getRootId(),r=e.getVOM(),n={total:0,vomTotal:0,children:[]},o=r.all(),s={};for(var l in o)o.hasOwnProperty(l)&&n.vomTotal++,s[l]=1;var c=function(e,i){var o=r.get(e);if(o){n.total++,i.id=o.id,delete s[o.id],o.fcc||o.$cr?i.status=t.created:o.fca||o.$ca?i.status=t.alter:i.status=t.init;var l=f.getEvents(o),d=l.length;if(d){var g=a.eventsCommonCount;d=Math.min(d,g);var m=a.eventsStartColor,u=a.eventsEndColor,h=(u.r-m.r)/g,v=(u.g-m.g)/g,p=(u.b-m.b)/g,x=("0"+parseInt(m.r+l.length*h).toString(16)).slice(-2),b=("0"+parseInt(m.g+l.length*v).toString(16)).slice(-2),M=("0"+parseInt(m.b+l.length*p).toString(16)).slice(-2);i.event="#"+x+b+M}var w=f.getShared(o);w.length&&(i.shared="#009966");var y=o.cM||o.$c;for(var _ in y){var I={children:[]};c(_,I),I.id&&i.children.push(I)}}};c(i,n);var d=[];for(var g in s)d.push({id:g,il:!0,status:t.isolated,children:[]});return n.isolated=d,n},getManagerTree:function(e){for(var t=e.getMangerMods(),i=[],n=0,o={},s=0,l={},c=0,d=0;d<t.length;d++){var g=t[d],m=g.exports.$mMetas||g.exports.$mm||g.exports.$m;m._$id||(m._$id="t"+c++),l[m._$id]&&(l[m._$id].continued=!0),l[m._$id]=g}for(var u=0;u<t.length;u++){var h,v,f=t[u],p=[],x={left:[],right:[]},b=[],M=0,w=0,y=0,_=f.exports.$mMetas||f.exports.$mm||f.exports.$m;if(delete _._$id,!f.continued){for(h in _)if(v=_[h],v.cleans)for(var I=(v.cleans+"").split(","),T=0;T<I.length;T++)o[I[T]]=h;for(h in _){v=_[h];var $=r.normal,C={id:h,color:$,url:v.url||v.uri,cache:(v.cache||0|v.cacheTime)/1e3+"sec",desc:v.desc||"",cleans:v.cleans||"",cleaned:o[h]||"",hasAfter:!!v.after};v.cleans?($=r.cleans,C.color=$,x.left.push(C),w++):o[h]?($=r.cleaned,C.color=$,x.right.push(C),y++):v.cache||v.cacheTime?($=r.cache,C.color=$,b.push(C)):(p.push(C),M++),s++}}n+=Math.ceil(M/a.managerCols),n+=Math.max(w,y),n+=Math.ceil(b.length/a.managerCols),i.push({name:f.name,rows:n,cleans:x,caches:b,maxLeft:w,maxRight:y,items:p})}return{groups:i,rows:n,total:s}},prepare:function(t){var a=f.getEnv();a.prepare();var i=function(){e.body&&a.isReady()?t():setTimeout(i,500)};i()},start:function(){f.prepare(function(){o.setup();var e,a=f.getEnv(),i=function(e){e.on("created",function(){s.log("vframe:"+e.id+"("+(e.path||e.view.path||"")+")渲染完毕",t.created),n()}),e.on("alter",function(a){s.log("vframe:"+e.id+"或子(孙)view"+(a.id?"("+a.id+")":"")+"正在更改",t.alter),n()}),e.on("viewInited",function(){s.log("vframe:"+e.id+"的view("+e.view.path+")，init调用完毕",t.created)}),e.on("viewUnmounted",function(){s.log("vframe:"+e.id+"的view("+(e.path||e.view&&e.view.path||"")+")销毁完毕",t.isolated)}),e.on("viewMounted",function(){s.log("vframe:"+e.id+"的view("+(e.path||e.view.path||"")+")，首次渲染完毕",t.created)}),e.___mh=!0},r=function(){var e=c.all();for(var t in e){var a=c.get(t);a.___mh||i(a)}},n=function(i){if(i)if("remove"==i.type)if(i.vframe){var n=i.vframe.path;!n&&i.vframe.view&&(n=i.vframe.view.path),n=n?"("+n+")":"",s.log("销毁vframe:"+i.vframe.id+n,t.isolated)}else s.log("remove:",i);else"created"==i.type&&r();clearTimeout(e),e=setTimeout(function(){var e=f.getTree(a);l.drawTree(e),a.drawIcons()},0)},c=a.getVOM();c.on("add",function(e){n(),e.vframe.pId&&s.log("找到vframe:"+e.vframe.pId+"的子vframe:"+e.vframe.id,t.build),s.log("创建vframe:"+e.vframe.id,t.build),i(e.vframe)}),c.on("remove",n);var d=c.get(a.getRootId());d&&d.on("created",n),r(),n();var g,m=function(){clearTimeout(g),g=setTimeout(function(){var e=f.getManagerTree(a);l.drawManagerTree(e)},500)};a.hookAttachMod(m),m()})}};f.start()}}();